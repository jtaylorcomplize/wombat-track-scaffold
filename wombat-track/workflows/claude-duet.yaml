# .github/workflows/claude-duet.yml
name: Claude Duet Implementation

on:
  issues:
    types: [labeled, opened]
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Implementation prompt from ChatGPT'
        required: true
        type: string
      issue_number:
        description: 'Issue number (optional)'
        required: false
        type: number

jobs:
  claude-implement:
    # Trigger on 'claude-implement' label or manual dispatch
    if: contains(github.event.label.name, 'claude-implement') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract Issue Content
        id: issue-content
        if: github.event_name == 'issues'
        run: |
          # Extract implementation specs from issue body
          issue_body="${{ github.event.issue.body }}"
          echo "issue_body<<EOF" >> $GITHUB_OUTPUT
          echo "$issue_body" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Implement with Claude Code
        id: claude-implementation
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt: |
            ${{ github.event.inputs.prompt || steps.issue-content.outputs.issue_body || 'Implement the Side Quest toggle feature for PhaseStep components as specified' }}
            
            Context: This is a TypeScript React project for wombat-track-scaffold.
            The main application code is in the `/wombat-track` subdirectory.
            
            Please:
            1. Analyze the current codebase structure in `/wombat-track`
            2. Implement the requested feature with proper TypeScript types
            3. Follow existing code patterns and conventions  
            4. Create or update necessary files in the correct locations
            5. Test that the implementation works
            6. Commit the changes with a descriptive message
            
            If this is about the Side Quest toggle feature:
            - Add isSideQuest?: boolean to PhaseStep interface in wombat-track/src/types/models.ts
            - Create StepCard.tsx component in wombat-track/src/ (create components/ subdirectory if needed)
            - Create PhasePlan.tsx component in wombat-track/src/ (create pages/ subdirectory if needed)  
            - Display toggle with üü• indicator when marked as Side Quest
            - Use local state management (no backend persistence)
            - Follow the existing Vite + React + TypeScript patterns shown in App.tsx
            
            Working directory: Change to /wombat-track subdirectory before starting implementation.
          
          allowed_tools: "Bash(git:*),View,GlobTool,GrepTool,BatchTool,Write"
          anthropic_api_key: ${{ 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 }}
          max_turns: "15"
          timeout_minutes: "10"
      
      - name: Create Pull Request
        if: steps.claude-implementation.outputs.conclusion == 'success'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat: implement ChatGPT ‚Üí Claude duet feature"
          title: "ü§ñ Claude Implementation: ${{ github.event.issue.title || github.event.inputs.prompt }}"
          body: |
            ## Claude Code Implementation
            
            **Triggered by**: ${{ github.event_name == 'issues' && 'Issue' || 'Manual workflow' }} 
            **Issue**: ${{ github.event.issue.html_url || 'Manual dispatch' }}
            
            ### Implementation Summary
            Claude Code has analyzed the repository and implemented the requested feature.
            
            **Execution Status**: ${{ steps.claude-implementation.outputs.conclusion }}
            
            ### Changes Made
            This PR contains the implementation generated by Claude Code based on the specifications provided.
            
            ### Testing
            Please review the changes and test the implementation before merging.
            
            ---
            *Generated by Claude Code via GitHub Actions*
          branch: claude-implementation-${{ github.run_number }}
          delete-branch: true
      
      - name: Comment on Issue
        if: github.event_name == 'issues' && steps.claude-implementation.outputs.conclusion == 'success'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ‚úÖ Claude Implementation Complete
              
              Claude Code has successfully implemented the requested feature!
              
              **Pull Request**: #${{ steps.create-pr.outputs.pull-request-number }}
              **Execution Status**: ${{ steps.claude-implementation.outputs.conclusion }}
              
              The implementation has been created in a new PR for your review.`
            });
      
      - name: Handle Implementation Failure
        if: steps.claude-implementation.outputs.conclusion == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            if (context.eventName === 'issues') {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ‚ùå Claude Implementation Failed
                
                The implementation could not be completed automatically.
                
                **Execution Status**: ${{ steps.claude-implementation.outputs.conclusion }}
                
                Please check the workflow logs for details and consider manual implementation.`
              });
            }
